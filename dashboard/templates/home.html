{% extends "layouts/base.html" %}
{% load l10n %}

{% block title %}Overview{% endblock %}

{% block content %}
{% localize off %}
<section class="grid cards-4">
    {% for card in user_summary_cards %}
    <article class="card">
        <div class="kpi-label">{{ card.label }}</div>
        <div class="kpi-value">{{ card.value }}</div>
        {% if card.change is not None and card.change > 0 %}
        <span class="change up">+{{ card.change }}%</span>
        {% elif card.change is not None and card.change < 0 %}
        <span class="change down">{{ card.change }}%</span>
        {% elif card.change is not None %}
        <span class="change flat">0%</span>
        {% endif %}
        <div class="kpi-sub">{{ card.sub }}</div>
    </article>
    {% endfor %}
</section>

<section class="grid cards-4">
    {% for card in summary_cards %}
    <article class="card">
        <div class="kpi-label">{{ card.label }}</div>
        <div class="kpi-value">{{ card.value }}</div>
        {% if card.change is not None and card.change > 0 %}
        <span class="change up">+{{ card.change }}%</span>
        {% elif card.change is not None and card.change < 0 %}
        <span class="change down">{{ card.change }}%</span>
        {% elif card.change is not None %}
        <span class="change flat">0%</span>
        {% endif %}
        <div class="kpi-sub">{{ card.sub }}</div>
    </article>
    {% endfor %}
</section>

<section class="grid cards-2">
    <article class="card">
        <h2 class="panel-title">User Progression</h2>
        <p class="panel-sub">Comparison against previous equal window</p>
        <table class="progress-table">
            <thead>
                <tr>
                    <th>Window</th>
                    <th>Current</th>
                    <th>Previous</th>
                    <th>Change</th>
                </tr>
            </thead>
            <tbody>
                {% for row in user_progression %}
                <tr>
                    <td>{{ row.window }}</td>
                    <td>{{ row.current }}</td>
                    <td>{{ row.previous }}</td>
                    <td>
                        {% if row.change > 0 %}
                        <span class="change up">+{{ row.change }}%</span>
                        {% elif row.change < 0 %}
                        <span class="change down">{{ row.change }}%</span>
                        {% else %}
                        <span class="change flat">0%</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </article>

    <article class="card">
        <h2 class="panel-title">Request Progression</h2>
        <p class="panel-sub">Comparison against previous equal window</p>
        <table class="progress-table">
            <thead>
                <tr>
                    <th>Window</th>
                    <th>Current</th>
                    <th>Previous</th>
                    <th>Change</th>
                </tr>
            </thead>
            <tbody>
                {% for row in progression %}
                <tr>
                    <td>{{ row.window }}</td>
                    <td>{{ row.current }}</td>
                    <td>{{ row.previous }}</td>
                    <td>
                        {% if row.change > 0 %}
                        <span class="change up">+{{ row.change }}%</span>
                        {% elif row.change < 0 %}
                        <span class="change down">{{ row.change }}%</span>
                        {% else %}
                        <span class="change flat">0%</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </article>
</section>

<section class="grid cards-2">
    <article class="card">
        <h2 class="panel-title">Core KPIs</h2>
        <p class="panel-sub">Only high-signal operational metrics</p>
        <div class="metric-row">
            <div class="pill">
                <div class="name">Total requests</div>
                <div class="num">{{ kpi.total_requests }}</div>
            </div>
            <div class="pill">
                <div class="name">Total users</div>
                <div class="num">{{ kpi.total_users }}</div>
            </div>
            <div class="pill">
                <div class="name">Requests (past 24h)</div>
                <div class="num">{{ kpi.requests_past_24h }}</div>
            </div>
            <div class="pill">
                <div class="name">Requests (past 30d)</div>
                <div class="num">{{ kpi.requests_past_30d }}</div>
            </div>
            <div class="pill">
                <div class="name">Avg requests per user</div>
                <div class="num">{{ kpi.avg_requests_per_user }}</div>
            </div>
            <div class="pill">
                <div class="name">Top request type share</div>
                <div class="num">{{ kpi.top_type_label }} ({{ kpi.top_type_share }}%)</div>
            </div>
        </div>
    </article>

    <article class="card">
        <h2 class="panel-title">User Growth (Last 30 Days)</h2>
        <p class="panel-sub">Daily new users trend</p>
        <div class="chart-wrap"><canvas id="chartUsers30"></canvas></div>
    </article>
</section>

<section class="grid cards-2">
    <article class="card">
        <h2 class="panel-title">Requests in Last 24 Hours</h2>
        <p class="panel-sub">Total volume with type-level behavior by hour</p>
        <div class="chart-wrap"><canvas id="chartHourly"></canvas></div>
    </article>

    <article class="card">
        <h2 class="panel-title">Request Mix (All Time)</h2>
        <p class="panel-sub">Distribution of bot usage categories</p>
        <div class="chart-wrap"><canvas id="chartMix"></canvas></div>
    </article>
</section>
{% endlocalize %}
{% endblock %}

{% block scripts %}
<script>
(function () {
    const hourly = JSON.parse('{{ chart_json.hourly|escapejs }}');
    const mix = JSON.parse('{{ chart_json.mix_total|escapejs }}');
    const daily = JSON.parse('{{ chart_json.daily|escapejs }}');

    new Chart(document.getElementById('chartHourly').getContext('2d'), {
        type: 'line',
        data: {
            labels: hourly.labels,
            datasets: [
                {
                    label: 'Total Requests',
                    data: hourly.total,
                    borderColor: '#0B84F3',
                    backgroundColor: 'rgba(11,132,243,0.14)',
                    borderWidth: 3,
                    fill: true,
                    tension: 0.3,
                },
                {
                    label: 'Question',
                    data: hourly.by_type.Question,
                    borderColor: '#17B26A',
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.3,
                },
                {
                    label: 'Test',
                    data: hourly.by_type.Test,
                    borderColor: '#FF8A00',
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.3,
                },
                {
                    label: 'AI',
                    data: hourly.by_type.AI,
                    borderColor: '#F04438',
                    borderDash: [6, 4],
                    fill: false,
                    tension: 0.3,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function (ctx) {
                            return ctx.dataset.label + ': ' + toEnglishDigits(ctx.formattedValue);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function (value) { return toEnglishDigits(value); }
                    }
                }
            }
        }
    });

    new Chart(document.getElementById('chartMix').getContext('2d'), {
        type: 'doughnut',
        data: {
            labels: mix.labels,
            datasets: [{ data: mix.data, backgroundColor: mix.colors, borderWidth: 0 }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            tooltips: {
                callbacks: {
                    label: function (tooltipItem, data) {
                        var label = data.labels[tooltipItem.index] || '';
                        var value = data.datasets[tooltipItem.datasetIndex].data[tooltipItem.index];
                        return label + ': ' + toEnglishDigits(value);
                    }
                }
            },
            cutout: '64%',
            plugins: { legend: { position: 'bottom' } }
        }
    });

    new Chart(document.getElementById('chartUsers30').getContext('2d'), {
        type: 'line',
        data: {
            labels: daily.labels,
            datasets: [{
                label: 'New Users',
                data: daily.users,
                borderColor: '#17B26A',
                backgroundColor: 'rgba(23,178,106,0.20)',
                borderWidth: 3,
                fill: true,
                tension: 0.3,
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'bottom' },
                tooltip: {
                    callbacks: {
                        label: function (ctx) {
                            return ctx.dataset.label + ': ' + toEnglishDigits(ctx.formattedValue);
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function (value) { return toEnglishDigits(value); }
                    }
                },
                x: { ticks: { maxTicksLimit: 10 } }
            }
        }
    });
})();
</script>
{% endblock %}
