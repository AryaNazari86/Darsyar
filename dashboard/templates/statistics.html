{% extends "layouts/base.html" %}
{% load l10n %}

{% block title %}Growth{% endblock %}

{% block content %}
{% localize off %}
<section class="grid cards-2">
    <article class="card">
        <h2 class="panel-title">30-Day Growth</h2>
        <p class="panel-sub">Daily requests and daily new-user acquisition</p>
        <div class="chart-wrap"><canvas id="chartDaily"></canvas></div>
    </article>

    <article class="card">
        <h2 class="panel-title">12-Month Trend</h2>
        <p class="panel-sub">Macro growth direction for bot usage and user onboarding</p>
        <div class="chart-wrap"><canvas id="chartMonthly"></canvas></div>
    </article>
</section>

<section class="grid cards-2">
    <article class="card">
        <h2 class="panel-title">Hour / Day / Month / Year Momentum</h2>
        <p class="panel-sub">Strong progression signal for recent and long-term behavior</p>
        <table class="progress-table">
            <thead>
                <tr>
                    <th>Window</th>
                    <th>Current Requests</th>
                    <th>Previous Window</th>
                    <th>Delta</th>
                </tr>
            </thead>
            <tbody>
                {% for row in progression %}
                <tr>
                    <td>{{ row.window }}</td>
                    <td>{{ row.current }}</td>
                    <td>{{ row.previous }}</td>
                    <td>
                        {% if row.change > 0 %}
                        <span class="change up">+{{ row.change }}%</span>
                        {% elif row.change < 0 %}
                        <span class="change down">{{ row.change }}%</span>
                        {% else %}
                        <span class="change flat">0%</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </article>

    <article class="card">
        <h2 class="panel-title">Request Type Mix (Last 30 Days)</h2>
        <p class="panel-sub">Where current demand is concentrated</p>
        <div class="chart-wrap"><canvas id="chartMix30"></canvas></div>
    </article>
</section>
{% endlocalize %}
{% endblock %}

{% block scripts %}
<script>
(function () {
    const daily = JSON.parse('{{ chart_json.daily|escapejs }}');
    const monthly = JSON.parse('{{ chart_json.monthly|escapejs }}');
    const mix30 = JSON.parse('{{ chart_json.mix_30d|escapejs }}');

    new Chart(document.getElementById('chartDaily').getContext('2d'), {
        type: 'bar',
        data: {
            labels: daily.labels,
            datasets: [
                {
                    label: 'Requests',
                    data: daily.logs,
                    backgroundColor: 'rgba(11,132,243,0.75)',
                    borderRadius: 6,
                },
                {
                    label: 'New Users',
                    data: daily.users,
                    backgroundColor: 'rgba(23,178,106,0.75)',
                    borderRadius: 6,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function (value) { return toEnglishDigits(value); }
                    }
                },
                x: { ticks: { maxTicksLimit: 10 } }
            }
        }
    });

    new Chart(document.getElementById('chartMonthly').getContext('2d'), {
        type: 'line',
        data: {
            labels: monthly.labels,
            datasets: [
                {
                    label: 'Requests',
                    data: monthly.logs,
                    borderColor: '#0B84F3',
                    backgroundColor: 'rgba(11,132,243,0.15)',
                    fill: true,
                    borderWidth: 3,
                    tension: 0.3,
                },
                {
                    label: 'New Users',
                    data: monthly.users,
                    borderColor: '#17B26A',
                    backgroundColor: 'rgba(23,178,106,0.15)',
                    fill: true,
                    borderWidth: 3,
                    tension: 0.3,
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        precision: 0,
                        callback: function (value) { return toEnglishDigits(value); }
                    }
                },
                x: { ticks: { maxTicksLimit: 6 } }
            }
        }
    });

    new Chart(document.getElementById('chartMix30').getContext('2d'), {
        type: 'polarArea',
        data: {
            labels: mix30.labels,
            datasets: [{ data: mix30.data, backgroundColor: mix30.colors }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'bottom' } },
            scales: {
                r: {
                    ticks: {
                        precision: 0,
                        callback: function (value) { return toEnglishDigits(value); }
                    }
                }
            }
        }
    });
})();
</script>
{% endblock %}
